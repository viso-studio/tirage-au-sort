<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viso Studio - Le Tirage</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background-color: #050505;
            color: #ffffff;
        }
        
        /* Utilitaires visuels */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .accent-glow {
            box-shadow: 0 0 30px -10px rgba(124, 58, 237, 0.3);
        }

        /* Animations discr√®tes */
        @keyframes fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .wheel-container {
            transition: transform 4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* Roue minimaliste */
        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 2px;
            top: 50%;
            left: 50%;
            transform-origin: 0% 50%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 24px;
            color: rgba(255,255,255,0.4);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .active-segment {
            color: #fff;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-purple-900 selection:text-white">

    <!-- Canvas Confettis (Noir et Blanc + Violet) -->
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50 hidden"></canvas>

    <!-- Header Minimaliste -->
    <header class="fixed w-full top-0 z-40 border-b border-white/5 bg-black/80 backdrop-blur-md">
        <div class="container mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center font-bold text-xl tracking-tighter"><img src="Frame5.png" alt="V"></div>
                <div>
                    <h1 class="text-xl font-bold uppercase tracking-widest leading-none">Viso Studio</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        <p id="header-status-text" class="text-[10px] text-gray-500 uppercase tracking-widest">En Direct</p>
                    </div>
                </div>
            </div>
            <div class="hidden md:block text-right">
                <p class="text-sm font-medium text-white">Jeu Concours 100 Abonn√©s</p>
                <p class="text-xs text-purple-400 mt-0.5">2 Gagnants x 20.000 FCFA</p>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col justify-center pt-24 pb-12 px-4 md:px-8">
        <div class="container mx-auto max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">

            <!-- Colonne Gauche : Info & Admin (Si connect√©) -->
            <div class="lg:col-span-4 flex flex-col gap-6 order-2 lg:order-1">
                
                <!-- Carte Prix - Design √âpur√© -->
                <div class="glass-panel p-8 rounded-none border-l-4 border-purple-600 animate-fade">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 block">R√©compense Totale</span>
                    <div class="flex items-baseline gap-2">
                        <h2 class="text-5xl font-light text-white">40<span class="text-purple-500">K</span></h2>
                        <span class="text-xl text-gray-400">FCFA</span>
                    </div>
                    <div class="mt-4 flex items-center gap-4 text-sm text-gray-400 border-t border-white/5 pt-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="users" size="14"></i>
                            <span>2 Gagnants</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="credit-card" size="14"></i>
                            <span>20K Chacun</span>
                        </div>
                    </div>
                </div>

                <!-- Zone Admin (Cach√©e par d√©faut) -->
                <div id="admin-panel" class="hidden glass-panel p-6 animate-fade">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-sm font-bold uppercase tracking-widest text-white flex items-center gap-2">
                            <i data-lucide="settings-2" size="14" class="text-purple-500"></i> Console Admin
                        </h3>
                        <span class="text-[10px] bg-purple-900/30 text-purple-400 px-2 py-0.5 border border-purple-500/30 uppercase">Secure</span>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase font-bold mb-2 block">Participants</label>
                            <textarea id="participants-input" class="w-full h-32 bg-black border border-white/10 p-3 text-xs text-gray-300 focus:border-purple-500 outline-none transition-colors font-mono resize-none" placeholder="Coller la liste ici..."></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <span id="participants-count" class="text-[10px] text-gray-600">0 Entr√©es</span>
                                <button onclick="document.getElementById('preview-modal').classList.toggle('hidden')" class="text-[10px] text-purple-400 hover:text-white underline cursor-pointer">Voir les num√©ros</button>
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] text-gray-500 uppercase font-bold mb-2 block">üòä</label>
                            <input type="text" id="rigged-input" class="w-full bg-black border border-white/10 p-2 text-xs text-white focus:border-purple-500 outline-none font-mono" placeholder="Ex: 3, 17">
                        </div>

                        <div class="pt-4 border-t border-white/5 flex gap-2">
                            <button id="btn-start-draw" class="flex-1 bg-white text-black hover:bg-purple-500 hover:text-white py-3 text-xs font-bold uppercase tracking-widest transition-all">
                                Lancer
                            </button>
                            <button id="btn-reset" class="px-4 border border-white/10 text-gray-400 hover:text-white hover:border-white py-3 text-xs font-bold uppercase transition-all">
                                <i data-lucide="rotate-ccw" size="14"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal Aper√ßu Participants -->
                <div id="preview-modal" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur flex items-center justify-center p-4">
                    <div class="glass-panel w-full max-w-md p-6 relative">
                        <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x" size="20"></i></button>
                        <h3 class="text-sm font-bold uppercase mb-4 text-white">Indexation des lignes</h3>
                        <div class="h-64 overflow-y-auto pr-2">
                            <ul id="participants-preview-list" class="text-xs font-mono space-y-1 text-gray-400"></ul>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Colonne Droite : La Sc√®ne (Roue) -->
            <div class="lg:col-span-8 flex items-center justify-center relative min-h-[500px] order-1 lg:order-2">
                
                <!-- Zone de tirage -->
                <div class="relative w-full max-w-2xl aspect-square flex items-center justify-center">
                    
                    <!-- Cercle d√©coratif fond -->
                    <div class="absolute inset-0 border border-white/5 rounded-full scale-90"></div>
                    <div class="absolute inset-0 border border-white/5 rounded-full scale-75 border-dashed opacity-30"></div>

                    <!-- LA ROUE -->
                    <div id="wheel-wrapper" class="relative w-[300px] h-[300px] md:w-[450px] md:h-[450px] z-10 transition-all duration-700">
                        <!-- Roue physique -->
                        <div id="wheel-container" class="w-full h-full rounded-full border border-white/10 bg-black shadow-2xl relative overflow-hidden wheel-container">
                            <!-- Segments JS -->
                        </div>
                        
                        <!-- Centre Statique -->
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-24 h-24 bg-black border border-white/10 rounded-full flex items-center justify-center z-20 shadow-2xl">
                            <span class="text-xs font-bold tracking-widest text-white">VISO</span>
                        </div>
                    </div>

                    <!-- Indicateur (Fl√®che) -->
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 z-20 translate-y-8">
                        <div class="w-0.5 h-8 bg-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.8)]"></div>
                    </div>

                    <!-- Overlay √âtat : IDLE -->
                    <div id="view-idle" class="absolute inset-0 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm z-30 animate-fade">
                        <h2 class="text-3xl md:text-5xl font-light text-white mb-2 tracking-tight">Le Tirage</h2>
                        <p class="text-gray-400 text-sm tracking-widest uppercase">En attente de lancement</p>
                    </div>

                    <!-- Overlay √âtat : R√âSULTATS -->
                    <div id="view-revealed" class="absolute inset-0 flex flex-col items-center justify-center bg-black/90 z-40 hidden">
                        <div class="text-center animate-fade">
                            <p class="text-purple-500 text-xs font-bold uppercase tracking-[0.3em] mb-6">Tirage Termin√©</p>
                            <div id="winners-container" class="flex flex-col md:flex-row gap-8 items-center justify-center">
                                <!-- Gagnants inject√©s ici -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- Footer Minimal -->
    <footer class="fixed bottom-0 w-full py-4 border-t border-white/5 bg-black z-50">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <p class="text-[10px] text-gray-600 uppercase tracking-widest">¬© Viso Studio 2025</p>
            
            <!-- Trigger Admin -->
            <button id="admin-trigger" class="text-[10px] text-gray-700 hover:text-white transition-colors flex items-center gap-2 uppercase tracking-widest">
                <i data-lucide="lock" size="10"></i> Admin
            </button>

            <!-- Login Modal (Inline) -->
            <div id="login-overlay" class="hidden absolute bottom-12 right-6 bg-black border border-white/10 p-4 w-64 shadow-2xl">
                <p class="text-[10px] text-gray-500 mb-2 uppercase">Code d'acc√®s</p>
                <div class="flex gap-2">
                    <input type="password" id="admin-pass" class="flex-1 bg-white/5 border border-white/10 p-2 text-xs text-white outline-none focus:border-purple-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <button id="btn-login" class="bg-white text-black px-3 py-1 text-xs font-bold uppercase">OK</button>
                </div>
            </div>
        </div>
    </footer>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';

        // --- Config ---
        const ADMIN_CODE = "VISO100";
        const firebaseConfig = {
            apiKey: "AIzaSyCc_IgakN9GZHLwsoIAtN0vlarwj3g9CPQ",
            authDomain: "tirrage-34d59.firebaseapp.com",
            projectId: "tirrage-34d59",
            storageBucket: "tirrage-34d59.firebasestorage.app",
            messagingSenderId: "433430821384",
            appId: "1:433430821384:web:2a1e0b11fda25a195a6fbd"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Init ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        lucide.createIcons();

        // --- State ---
        let isAdmin = false;
        let appStatus = 'idle'; 
        let currentRotation = 0;
        let participantsText = "Participant 1\nParticipant 2";
        let winnersData = [];

        // --- UI Refs ---
        const els = {
            wheel: document.getElementById('wheel-container'),
            wheelWrapper: document.getElementById('wheel-wrapper'),
            viewIdle: document.getElementById('view-idle'),
            viewRevealed: document.getElementById('view-revealed'),
            winnersBox: document.getElementById('winners-container'),
            adminPanel: document.getElementById('admin-panel'),
            participantsInput: document.getElementById('participants-input'),
            participantsPreview: document.getElementById('participants-preview-list'),
            participantsCount: document.getElementById('participants-count'),
            riggedInput: document.getElementById('rigged-input'),
            startBtn: document.getElementById('btn-start-draw'),
            resetBtn: document.getElementById('btn-reset'),
            loginOverlay: document.getElementById('login-overlay'),
            adminPass: document.getElementById('admin-pass'),
            confetti: document.getElementById('confetti-canvas')
        };

        // --- Auth ---
        signInAnonymously(auth).catch(e => console.error("Auth Error", e));
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // IMPORTANT: CORRECTION DU CHEMIN FIREBASE (6 segments)
                // Collection: artifacts/appId/public
                // Document: data
                // Collection: concours-viso-live-v2
                // Document: state (ID du document)
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'concours-viso-live-v2', 'gameState');
                
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        handleDataUpdate(data);
                    } else if (isAdmin) {
                        setDoc(docRef, { status: 'idle', participants: participantsText, winners: [] });
                    }
                });
            }
        });

        // --- Logic ---
        function handleDataUpdate(data) {
            participantsText = data.participants || "";
            winnersData = data.winners || [];
            
            // Sync Admin input if idle
            if (isAdmin && document.activeElement !== els.participantsInput) {
                els.participantsInput.value = participantsText;
            }
            
            updateListPreview();
            
            if (data.status !== appStatus) {
                appStatus = data.status;
                handleStatusTransition(appStatus, winnersData);
            }
            
            updateUI();
        }

        function handleStatusTransition(status, winners) {
            if (status === 'spin_1') {
                currentRotation += 1440 + Math.random() * 360; // 4 tours min
                rotateWheel(currentRotation);
            } 
            else if (status === 'reveal_1') {
                if (winners[0]) alignWheelToWinner(winners[0].index);
            } 
            else if (status === 'spin_2') {
                currentRotation += 1440 + Math.random() * 360;
                rotateWheel(currentRotation);
            } 
            else if (status === 'reveal_2') {
                if (winners[1]) alignWheelToWinner(winners[1].index);
            }
            else if (status === 'finished') {
                els.viewRevealed.classList.remove('hidden');
                startConfetti();
            }
            else if (status === 'idle') {
                els.viewRevealed.classList.add('hidden');
                stopConfetti();
                currentRotation = 0;
                rotateWheel(0);
            }
        }

        function rotateWheel(deg) {
            els.wheel.style.transform = `rotate(${deg}deg)`;
        }

        function alignWheelToWinner(index) {
            const list = getList();
            const count = list.length;
            const slice = 360 / count;
            
            // La fl√®che est en HAUT (270deg visuel, ou -90). 
            // CSS rotate 0 = Droite.
            // Pour aligner l'index X en haut :
            const targetAngle = -(index * slice) - 90; 
            
            // Calculer la rotation la plus proche en avant
            const currentMod = currentRotation % 360;
            const diff = targetAngle - currentMod;
            let final = currentRotation + diff;
            
            // Ajouter des tours pour l'effet d'atterrissage
            if (final <= currentRotation) final += 360; 
            
            currentRotation = final;
            rotateWheel(currentRotation);
        }

        function updateUI() {
            // Idle View
            if (appStatus === 'idle') {
                els.viewIdle.classList.remove('hidden');
                els.wheelWrapper.style.opacity = '0.3'; // Roue discr√®te en idle
                els.wheelWrapper.style.transform = 'scale(0.9)';
            } else {
                els.viewIdle.classList.add('hidden');
                els.wheelWrapper.style.opacity = '1';
                els.wheelWrapper.style.transform = 'scale(1)';
            }

            // Winners UI
            if (winnersData.length > 0) {
                els.winnersBox.innerHTML = winnersData.map((w, i) => `
                    <div class="glass-panel p-6 border-t-2 border-purple-500 text-center min-w-[200px] animate-fade">
                        <p class="text-xl font-bold text-white mb-1">${w.name}</p>
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <span class="text-purple-400 font-mono">20.000 FCFA</span>
                        </div>
                    </div>
                `).join('');
            }

            // Button State
            if (appStatus !== 'idle' && appStatus !== 'finished') {
                els.startBtn.disabled = true;
                els.startBtn.innerText = "Tirage en cours...";
                els.startBtn.classList.add('opacity-50');
            } else {
                els.startBtn.disabled = false;
                els.startBtn.innerText = "LANCER LE TIRAGE";
                els.startBtn.classList.remove('opacity-50');
            }
        }

        function renderWheelSegments() {
            const list = getList();
            els.wheel.innerHTML = '';
            
            if (list.length === 0) return;
            
            const slice = 360 / list.length;
            
            list.forEach((name, i) => {
                const el = document.createElement('div');
                el.className = 'wheel-segment';
                el.style.transform = `rotate(${i * slice + slice/2}deg)`;
                
                const span = document.createElement('span');
                span.innerText = name.length > 15 ? name.substring(0, 15) + '..' : name;
                el.appendChild(span);
                
                // Ligne de s√©paration fine
                const line = document.createElement('div');
                line.style.position = 'absolute';
                line.style.top = '50%';
                line.style.left = '50%';
                line.style.width = '50%';
                line.style.height = '1px';
                line.style.background = 'rgba(255,255,255,0.05)';
                line.style.transformOrigin = '0% 0%';
                line.style.transform = `rotate(${i * slice}deg)`;
                
                els.wheel.appendChild(line);
                els.wheel.appendChild(el);
            });
        }

        function getList() {
            return participantsText.split('\n').map(s => s.trim()).filter(s => s);
        }

        function updateListPreview() {
            const list = getList();
            els.participantsCount.innerText = list.length + " Entr√©es";
            els.participantsPreview.innerHTML = list.map((n, i) => 
                `<li class="flex justify-between border-b border-white/5 py-1"><span>${n}</span> <span class="text-purple-500 font-bold">${i+1}</span></li>`
            ).join('');
            renderWheelSegments();
        }

        // --- Admin Actions ---
        
        els.participantsInput.addEventListener('input', (e) => {
            participantsText = e.target.value;
            updateListPreview();
        });

        document.getElementById('admin-trigger').addEventListener('click', () => {
             if(isAdmin) return;
             els.loginOverlay.classList.toggle('hidden');
        });

        document.getElementById('btn-login').addEventListener('click', () => {
            if (els.adminPass.value === ADMIN_CODE) {
                isAdmin = true;
                els.adminPanel.classList.remove('hidden');
                els.loginOverlay.classList.add('hidden');
                // Init doc
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'concours-viso-live-v2', 'gameState');
                setDoc(docRef, { status: appStatus, participants: participantsText, winners: winnersData }, {merge: true});
            } else {
                alert("Code erron√©");
            }
        });

        els.startBtn.addEventListener('click', async () => {
            const list = getList();
            if (list.length < 2) return alert("2 participants minimum");

            // Winners Logic
            let indices = [];
            const rig = els.riggedInput.value;
            if (rig) {
                indices = rig.split(',').map(x => parseInt(x.trim()) - 1);
                if (indices.length !== 2 || indices.some(isNaN)) return alert("Format invalide (Ex: 1, 5)");
            } else {
                indices = list.map((_, i) => i).sort(() => Math.random() - 0.5).slice(0, 2);
            }

            const winners = indices.map(i => ({ name: list[i], index: i }));
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'concours-viso-live-v2', 'gameState');

            // Sequence
            try {
                await updateDoc(docRef, { status: 'spin_1', winners, participants: participantsText });
                setTimeout(async () => {
                    await updateDoc(docRef, { status: 'reveal_1' });
                    setTimeout(async () => {
                        await updateDoc(docRef, { status: 'spin_2' });
                        setTimeout(async () => {
                            await updateDoc(docRef, { status: 'reveal_2' });
                            setTimeout(async () => {
                                await updateDoc(docRef, { status: 'finished' });
                            }, 4000);
                        }, 5000);
                    }, 4000);
                }, 5000);
            } catch (e) {
                alert("Erreur Firebase: " + e.message);
            }
        });

        els.resetBtn.addEventListener('click', async () => {
            if(confirm('Reset ?')) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'concours-viso-live-v2', 'gameState');
                await updateDoc(docRef, { status: 'idle', winners: [] });
            }
        });

        // --- Confetti (Noir/Blanc/Violet) ---
        let confettiId;
        function startConfetti() {
            els.confetti.classList.remove('hidden');
            const ctx = els.confetti.getContext('2d');
            els.confetti.width = window.innerWidth;
            els.confetti.height = window.innerHeight;
            
            const particles = Array.from({length: 150}, () => ({
                x: Math.random() * els.confetti.width,
                y: Math.random() * els.confetti.height - els.confetti.height,
                color: ['#ffffff', '#7c3aed', '#333333'][Math.floor(Math.random() * 3)],
                size: Math.random() * 6 + 2,
                speed: Math.random() * 5 + 2
            }));

            function loop() {
                ctx.clearRect(0,0,els.confetti.width, els.confetti.height);
                particles.forEach(p => {
                    p.y += p.speed;
                    if(p.y > els.confetti.height) p.y = -10;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                });
                confettiId = requestAnimationFrame(loop);
            }
            loop();
        }
        function stopConfetti() {
            cancelAnimationFrame(confettiId);
            els.confetti.classList.add('hidden');
        }

    </script>
</body>

</html>







